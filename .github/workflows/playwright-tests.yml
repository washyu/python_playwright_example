name: Playwright Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

    - name: Install Playwright browsers
      run: uv run playwright install chromium --with-deps

    - name: Run Playwright tests
      run: uv run pytest -v
      # Tests will run headless by default (no HEADED env var set)
      # To run headed locally, set: export HEADED=true

    - name: Upload HTML report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload failure screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-screenshots
        path: test-results/screenshots/
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload manual test screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: screenshots/
        retention-days: 30
        if-no-files-found: ignore

    - name: Publish Test Results
      if: always()
      uses: mikepenz/action-junit-report@v4
      with:
        report_paths: 'test-results/junit.xml'
        detailed_summary: true
        include_passed: true
        check_name: 'Playwright Test Results'
        fail_on_failure: true
